#!/usr/bin/env bash


help(){
    cat<<__EOF__
Usage: m wallpaper [OPTIONS]

Description: Set the desktop wallpaper to the specified image file

Options:
  --help             Show this help message
  --set IMAGE_PATH  Set the wallpaper to the specified image file


Examples:
  m wallpaper --set ~/wallpapers/tree.jpg       # set wallpaper
__EOF__
}

WALLPAPER_PLIST="${HOME}/Library/Application Support/com.apple.wallpaper/Store/Index.plist"

set_wallpaper(){
    local image_path="${1}"

    # Expand ~ to full path
    image_path="${image_path/#\~/$HOME}"

    # Set wallpaper via osascript
    osascript -e "tell application \"System Events\" to tell every desktop to set picture to \"${image_path}\" as POSIX file"

    sleep 1

    # Clear individual space/display settings to apply to all spaces
    /usr/libexec/PlistBuddy -c "Delete :Spaces" "$WALLPAPER_PLIST" 2>/dev/null
    /usr/libexec/PlistBuddy -c "Add :Spaces dict" "$WALLPAPER_PLIST"
    /usr/libexec/PlistBuddy -c "Delete :Displays" "$WALLPAPER_PLIST" 2>/dev/null
    /usr/libexec/PlistBuddy -c "Add :Displays dict" "$WALLPAPER_PLIST"

    # Restart WallpaperAgent to apply changes
    killall WallpaperAgent 2>/dev/null
}

case $1 in
    --help)
        help
        ;;
    --set)
        shift
        [ -z "$1" ] && help && exit 1
        set_wallpaper "$1"
        ;;
    *)
        help && exit 1
        ;;
esac
